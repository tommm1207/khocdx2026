/**
 * Google Apps Script API cho Dashboard Qu·∫£n L√Ω T·ªïng H·ª£p
 * 3 Nghi·ªáp v·ª• ch√≠nh: Mua s·∫Øm, Nh·∫≠p xu·∫•t t·ªìn, Qu·∫£n l√Ω nh√¢n s·ª±
 * 
 * Author: Assistant
 * Date: 2025
 */

// === MAIN API ENDPOINT ===
function doGet(e) {
  try {
    // üîß FIX: X·ª≠ l√Ω tr∆∞·ªùng h·ª£p e ho·∫∑c e.parameter undefined
    const parameter = (e && e.parameter) ? e.parameter : {};
    const action = parameter.action || 'getAll';
    
    console.log('doGet called with action:', action);
    console.log('Parameters:', parameter);
    
    // X·ª≠ l√Ω c√°c lo·∫°i request kh√°c nhau
    switch (action) {
      case 'getAll':
        return getAllData();
      case 'getBusinessData':
        return getBusinessData(parameter.business);
      case 'getUserData':
        return getUserDataOnly();
      case 'getStats':
        return getStatistics();
      case 'getFiltered':
        return getFilteredData(parameter);
      default:
        return getAllData();
    }
    
  } catch (error) {
    console.error('L·ªói trong doGet:', error);
    console.error('Error stack:', error.stack);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        error: 'C√≥ l·ªói x·∫£y ra: ' + error.message,
        details: error.stack,
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// === CONFIGURATION ===
const CONFIG = {
  // C·∫•u h√¨nh t√™n c√°c sheet
  SHEETS: {
    // Core tables
    USER: 'User',
    
    // Nghi·ªáp v·ª• 1: Mua s·∫Øm
    CHIPHI: 'Chiphi',
    CHIPHI_CHITIET: 'Chiphichitiet',
    BO_LOC_CHI_PHI: 'BoLocChiPhi',
    
    // Nghi·ªáp v·ª• 2: Nh·∫≠p xu·∫•t t·ªìn
    PHIEU_NHAP_XUAT: 'PhieuNhapXuat',
    PNX_CHI_TIET: 'PNXChiTiet',
    VAT_LIEU: 'VatLieu',
    DS_KHO: 'DS_kho',
    TON_KHO: 'Tonkho',
    PHIEU_CHUYEN_KHO: 'Phieuchuyenkho',
    CHUYEN_KHO_CHI_TIET: 'Chuyenkhochitiet',
    DOI_TAC: 'Doitac',
    LOC_NXT: 'LocNXT',
    
    // Nghi·ªáp v·ª• 3: Qu·∫£n l√Ω nh√¢n s·ª±
    CHAM_CONG: 'Chamcong',
    LICH_SU_LUONG: 'LichSuLuong',
    GIAO_DICH_LUONG: 'GiaoDichLuong',
    BANG_LUONG_THANG: 'BangLuongThang',
    LUONG_PHU_CAP: 'Luongphucap',
    BAN_GIAO_CONG_CU: 'BanGiaoCongCu',
    BANG_DIEU_KHIEN_TINH_LUONG: 'BangDieuKhien_TinhLuong',
    
    // Support tables
    DROP: 'Drop',
    MENU: 'Menu',
    NOTES: 'Notes',
    LICH_NHAC: 'LichNhac'
  }
};

// === UTILITY FUNCTIONS ===

/**
 * L·∫•y spreadsheet hi·ªán t·∫°i
 */
function getSpreadsheet() {
  return SpreadsheetApp.getActiveSpreadsheet();
}

/**
 * Ki·ªÉm tra sheet c√≥ t·ªìn t·∫°i
 */
function sheetExists(sheetName) {
  try {
    const sheet = getSpreadsheet().getSheetByName(sheetName);
    return sheet !== null;
  } catch (e) {
    return false;
  }
}

/**
 * Chuy·ªÉn ƒë·ªïi range th√†nh array of objects
 */
function rangeToObjects(range, sheetName) {
  if (!range || range.length === 0) {
    return [];
  }
  
  const headers = range[0];
  const dataRows = range.slice(1);
  
  return dataRows.map((row, index) => {
    const obj = {};
    headers.forEach((header, colIndex) => {
      let value = row[colIndex];
      
      // X·ª≠ l√Ω gi√° tr·ªã null/undefined
      if (value === null || value === undefined) {
        value = '';
      }
      
      // Chuy·ªÉn ƒë·ªïi Date
      if (value instanceof Date) {
        value = Utilities.formatDate(value, Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');
      }
      
      // X·ª≠ l√Ω boolean
      if (typeof value === 'boolean') {
        value = value;
      }
      
      obj[header] = value;
    });
    
    // Th√™m metadata
    obj._rowIndex = index + 2; // +2 v√¨ b·∫Øt ƒë·∫ßu t·ª´ row 2
    obj._sheetName = sheetName;
    
    return obj;
  });
}

/**
 * L·∫•y d·ªØ li·ªáu t·ª´ sheet v·ªõi error handling
 */
function getDataFromSheet(sheetName, maxRows = null) {
  try {
    if (!sheetExists(sheetName)) {
      console.warn(`Sheet "${sheetName}" kh√¥ng t·ªìn t·∫°i.`);
      return [];
    }
    
    const sheet = getSpreadsheet().getSheetByName(sheetName);
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    
    if (lastRow <= 1 || lastCol === 0) {
      console.warn(`Sheet "${sheetName}" tr·ªëng ho·∫∑c ch·ªâ c√≥ header.`);
      return [];
    }
    
    // X√°c ƒë·ªãnh s·ªë h√†ng c·∫ßn l·∫•y
    const rowsToGet = maxRows ? Math.min(maxRows, lastRow - 1) : lastRow - 1;
    
    const range = sheet.getRange(1, 1, rowsToGet + 1, lastCol).getValues();
    return rangeToObjects(range, sheetName);
    
  } catch (error) {
    console.error(`L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ sheet "${sheetName}":`, error);
    return [];
  }
}

/**
 * L·ªçc d·ªØ li·ªáu theo ƒëi·ªÅu ki·ªán (lo·∫°i b·ªè Delete = true)
 */
function filterActiveRecords(data) {
  // üîß FIX: Ki·ªÉm tra data c√≥ t·ªìn t·∫°i v√† l√† array kh√¥ng
  if (!data || !Array.isArray(data)) {
    console.warn('filterActiveRecords: data is not an array:', data);
    return [];
  }
  
  return data.filter(record => {
    // Ki·ªÉm tra record c√≥ t·ªìn t·∫°i kh√¥ng
    if (!record) return false;
    
    // Lo·∫°i b·ªè c√°c b·∫£n ghi c√≥ Delete = true ho·∫∑c Delete = 'true'
    if (record.Delete === true || record.Delete === 'true' || record.Delete === 'TRUE') {
      return false;
    }
    return true;
  });
}

// === MAIN DATA RETRIEVAL FUNCTIONS ===

/**
 * L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ c√°c sheet
 */
function getAllData() {
  const startTime = new Date().getTime();
  
  try {
    // üîß FIX: Th√™m error handling cho t·ª´ng sheet
    console.log('B·∫Øt ƒë·∫ßu l·∫•y d·ªØ li·ªáu t·ª´ t·∫•t c·∫£ sheet...');
    
    const allData = {
      metadata: {
        timestamp: new Date().toISOString(),
        totalSheets: 0,
        loadTime: 0,
        errors: []
      },
      
      // Core data
      users: [],
      
      // Nghi·ªáp v·ª• 1: Mua s·∫Øm
      shopping: {
        chiphi: [],
        chiphiChitiet: [],
        boLocChiPhi: []
      },
      
      // Nghi·ªáp v·ª• 2: Nh·∫≠p xu·∫•t t·ªìn
      inventory: {
        phieuNhapXuat: [],
        pnxChiTiet: [],
        vatLieu: [],
        dsKho: [],
        tonKho: [],
        phieuChuyenKho: [],
        chuyenKhoChiTiet: [],
        doiTac: [],
        locNXT: []
      },
      
      // Nghi·ªáp v·ª• 3: Qu·∫£n l√Ω nh√¢n s·ª±
      hr: {
        chamCong: [],
        lichSuLuong: [],
        giaoDichLuong: [],
        bangLuongThang: [],
        luongPhuCap: [],
        banGiaoCongCu: [],
        bangDieuKhienTinhLuong: []
      },
      
      // Support data
      support: {
        drop: [],
        menu: [],
        notes: [],
        lichNhac: []
      }
    };

    // L·∫•y d·ªØ li·ªáu User tr∆∞·ªõc (quan tr·ªçng nh·∫•t)
    try {
      console.log('ƒêang l·∫•y d·ªØ li·ªáu User...');
      const userData = getDataFromSheet(CONFIG.SHEETS.USER);
      allData.users = filterActiveRecords(userData);
      console.log(`‚úÖ User: ${allData.users.length} b·∫£n ghi`);
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu User:', error);
      allData.metadata.errors.push(`User: ${error.message}`);
    }

    // L·∫•y d·ªØ li·ªáu Shopping
    try {
      console.log('ƒêang l·∫•y d·ªØ li·ªáu Shopping...');
      allData.shopping.chiphi = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI));
      allData.shopping.chiphiChitiet = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI_CHITIET));
      allData.shopping.boLocChiPhi = getDataFromSheet(CONFIG.SHEETS.BO_LOC_CHI_PHI) || [];
      console.log(`‚úÖ Shopping data loaded`);
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu Shopping:', error);
      allData.metadata.errors.push(`Shopping: ${error.message}`);
    }

    // L·∫•y d·ªØ li·ªáu Inventory
    try {
      console.log('ƒêang l·∫•y d·ªØ li·ªáu Inventory...');
      allData.inventory.phieuNhapXuat = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_NHAP_XUAT));
      allData.inventory.pnxChiTiet = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PNX_CHI_TIET));
      allData.inventory.vatLieu = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.VAT_LIEU));
      allData.inventory.dsKho = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DS_KHO));
      allData.inventory.tonKho = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.TON_KHO));
      allData.inventory.phieuChuyenKho = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_CHUYEN_KHO));
      allData.inventory.chuyenKhoChiTiet = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHUYEN_KHO_CHI_TIET));
      allData.inventory.doiTac = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DOI_TAC));
      allData.inventory.locNXT = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.LOC_NXT));
      console.log(`‚úÖ Inventory data loaded`);
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu Inventory:', error);
      allData.metadata.errors.push(`Inventory: ${error.message}`);
    }

    // L·∫•y d·ªØ li·ªáu HR
    try {
      console.log('ƒêang l·∫•y d·ªØ li·ªáu HR...');
      allData.hr.chamCong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG));
      allData.hr.lichSuLuong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.LICH_SU_LUONG));
      allData.hr.giaoDichLuong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.GIAO_DICH_LUONG));
      allData.hr.bangLuongThang = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.BANG_LUONG_THANG));
      allData.hr.luongPhuCap = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.LUONG_PHU_CAP));
      allData.hr.banGiaoCongCu = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.BAN_GIAO_CONG_CU));
      allData.hr.bangDieuKhienTinhLuong = getDataFromSheet(CONFIG.SHEETS.BANG_DIEU_KHIEN_TINH_LUONG) || [];
      console.log(`‚úÖ HR data loaded`);
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu HR:', error);
      allData.metadata.errors.push(`HR: ${error.message}`);
    }

    // L·∫•y d·ªØ li·ªáu Support
    try {
      console.log('ƒêang l·∫•y d·ªØ li·ªáu Support...');
      allData.support.drop = getDataFromSheet(CONFIG.SHEETS.DROP) || [];
      allData.support.menu = getDataFromSheet(CONFIG.SHEETS.MENU) || [];
      allData.support.notes = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.NOTES));
      allData.support.lichNhac = getDataFromSheet(CONFIG.SHEETS.LICH_NHAC) || [];
      console.log(`‚úÖ Support data loaded`);
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu Support:', error);
      allData.metadata.errors.push(`Support: ${error.message}`);
    }
    
    // T√≠nh to√°n metadata
    const endTime = new Date().getTime();
    allData.metadata.loadTime = endTime - startTime;
    allData.metadata.totalSheets = Object.keys(CONFIG.SHEETS).length;
    
    // ƒê·∫øm s·ªë b·∫£n ghi
    allData.metadata.recordCounts = {
      users: allData.users.length,
      shopping: Object.values(allData.shopping).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
      inventory: Object.values(allData.inventory).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
      hr: Object.values(allData.hr).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0),
      support: Object.values(allData.support).reduce((sum, arr) => sum + (Array.isArray(arr) ? arr.length : 0), 0)
    };
    
    console.log('‚úÖ ƒê√£ t·∫£i xong t·∫•t c·∫£ d·ªØ li·ªáu:', allData.metadata);
    
    return ContentService
      .createTextOutput(JSON.stringify(allData))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error('‚ùå L·ªói nghi√™m tr·ªçng trong getAllData:', error);
    return ContentService
      .createTextOutput(JSON.stringify({
        error: 'L·ªói nghi√™m tr·ªçng khi l·∫•y d·ªØ li·ªáu: ' + error.message,
        details: error.stack,
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * L·∫•y d·ªØ li·ªáu theo nghi·ªáp v·ª•
 */
function getBusinessData(businessType) {
  const users = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.USER));
  const userMap = createUserMap(users);
  
  let businessData = {};
  
  switch (businessType) {
    case 'shopping':
    case 'muasam':
      businessData = {
        users: users,
        chiphi: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI)), userMap),
        chiphiChitiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI_CHITIET)),
        boLocChiPhi: getDataFromSheet(CONFIG.SHEETS.BO_LOC_CHI_PHI)
      };
      break;
      
    case 'inventory':
    case 'nhapxuatton':
      businessData = {
        users: users,
        phieuNhapXuat: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_NHAP_XUAT)),
        pnxChiTiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PNX_CHI_TIET)),
        vatLieu: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.VAT_LIEU)),
        dsKho: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DS_KHO)),
        tonKho: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.TON_KHO)),
        phieuChuyenKho: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_CHUYEN_KHO)),
        chuyenKhoChiTiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHUYEN_KHO_CHI_TIET)),
        doiTac: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DOI_TAC))
      };
      break;
      
    case 'hr':
    case 'nhansu':
      businessData = {
        users: users,
        chamCong: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG)), userMap),
        lichSuLuong: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.LICH_SU_LUONG)), userMap),
        giaoDichLuong: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.GIAO_DICH_LUONG)), userMap),
        bangLuongThang: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.BANG_LUONG_THANG)), userMap),
        luongPhuCap: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.LUONG_PHU_CAP)), userMap),
        banGiaoCongCu: enrichWithUserData(filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.BAN_GIAO_CONG_CU)), userMap),
        bangDieuKhienTinhLuong: getDataFromSheet(CONFIG.SHEETS.BANG_DIEU_KHIEN_TINH_LUONG)
      };
      break;
      
    default:
      businessData = { error: 'Nghi·ªáp v·ª• kh√¥ng h·ª£p l·ªá. S·ª≠ d·ª•ng: shopping, inventory, hr' };
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(businessData))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Ch·ªâ l·∫•y d·ªØ li·ªáu User
 */
function getUserDataOnly() {
  const users = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.USER));
  const dropData = getDataFromSheet(CONFIG.SHEETS.DROP);
  
  return ContentService
    .createTextOutput(JSON.stringify({
      users: users,
      dropdownData: dropData
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

// === HELPER FUNCTIONS ===

/**
 * T·∫°o map User ƒë·ªÉ join d·ªØ li·ªáu
 */
function createUserMap(users) {
  // üîß FIX: Ki·ªÉm tra users c√≥ t·ªìn t·∫°i v√† l√† array kh√¥ng
  if (!users || !Array.isArray(users)) {
    console.warn('createUserMap: users is not an array:', users);
    return {};
  }
  
  const userMap = {};
  users.forEach(user => {
    // Ki·ªÉm tra user c√≥ ID kh√¥ng
    if (user && user.ID) {
      userMap[user.ID] = user;
    }
  });
  return userMap;
}

/**
 * L√†m gi√†u d·ªØ li·ªáu v·ªõi th√¥ng tin User
 */
function enrichWithUserData(data, userMap) {
  // üîß FIX: Ki·ªÉm tra data v√† userMap c√≥ t·ªìn t·∫°i kh√¥ng
  if (!data || !Array.isArray(data)) {
    console.warn('enrichWithUserData: data is not an array:', data);
    return [];
  }
  
  if (!userMap || typeof userMap !== 'object') {
    console.warn('enrichWithUserData: userMap is not an object:', userMap);
    return data; // Tr·∫£ v·ªÅ data g·ªëc n·∫øu kh√¥ng c√≥ userMap
  }
  
  return data.map(record => {
    // Ki·ªÉm tra record c√≥ t·ªìn t·∫°i kh√¥ng
    if (!record || typeof record !== 'object') {
      console.warn('enrichWithUserData: invalid record:', record);
      return record;
    }
    
    // T√¨m ID nh√¢n vi√™n trong record
    const userIdField = record.ID_NhanVien || record['ID nh√¢n vi√™n'] || record.NguoiLap || record.ChonNhanVien;
    
    if (userIdField && userMap[userIdField]) {
      const user = userMap[userIdField];
      record._userData = {
        hoTen: user['H·ªç v√† t√™n'] || '',
        email: user.Email || '',
        boPhan: user['B·ªô ph·∫≠n'] || '',
        chucVu: user['Ch·ª©c v·ª•'] || ''
      };
    }
    
    return record;
  });
}

/**
 * L·∫•y th·ªëng k√™ t·ªïng quan
 */
function getStatistics() {
  try {
    const users = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.USER));
    const chamCong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG));
    const giaoDichLuong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.GIAO_DICH_LUONG));
    const tonKho = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.TON_KHO));
    const chiphi = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI));
    
    // Th·ªëng k√™ nh√¢n s·ª±
    const hrStats = {
      totalEmployees: users.length,
      activeEmployees: users.filter(u => u['Tr·∫°ng th√°i'] !== 'Ngh·ªâ vi·ªác').length,
      totalWorkHours: chamCong.reduce((sum, record) => sum + (parseFloat(record.SoGioCong) || 0), 0),
      totalOvertimeHours: chamCong.reduce((sum, record) => sum + (parseFloat(record.SoGioTangCa) || 0), 0),
      totalSalaryPaid: giaoDichLuong
        .filter(g => g.LoaiGiaoDich === 'Chi l∆∞∆°ng')
        .reduce((sum, record) => sum + (parseFloat(record.SoTien) || 0), 0)
    };
    
    // Th·ªëng k√™ kho
    const inventoryStats = {
      totalItems: tonKho.length,
      totalValue: tonKho.reduce((sum, record) => sum + (parseFloat(record.SoLuongTon) || 0), 0)
    };
    
    // Th·ªëng k√™ chi ph√≠
    const costStats = {
      totalExpenses: chiphi.reduce((sum, record) => sum + (parseFloat(record.TongSoTien) || 0), 0),
      totalTransactions: chiphi.length
    };
    
    const stats = {
      timestamp: new Date().toISOString(),
      hr: hrStats,
      inventory: inventoryStats,
      costs: costStats,
      summary: {
        totalUsers: users.length,
        totalRecords: chamCong.length + giaoDichLuong.length + tonKho.length + chiphi.length
      }
    };
    
    return ContentService
      .createTextOutput(JSON.stringify(stats))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        error: 'L·ªói khi t√≠nh to√°n th·ªëng k√™: ' + error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * L·∫•y d·ªØ li·ªáu c√≥ l·ªçc
 */
function getFilteredData(params) {
  try {
    const business = params.business || 'hr';
    const fromDate = params.fromDate;
    const toDate = params.toDate;
    const userId = params.userId;
    
    // L·∫•y d·ªØ li·ªáu base
    let data = {};
    switch (business) {
      case 'hr':
        data = {
          chamCong: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG)),
          giaoDichLuong: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.GIAO_DICH_LUONG))
        };
        break;
      case 'inventory':
        data = {
          phieuNhapXuat: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_NHAP_XUAT)),
          pnxChiTiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PNX_CHI_TIET))
        };
        break;
      case 'shopping':
        data = {
          chiphi: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI))
        };
        break;
    }
    
    // √Åp d·ª•ng filter
    if (fromDate || toDate || userId) {
      Object.keys(data).forEach(key => {
        data[key] = data[key].filter(record => {
          let include = true;
          
          // Filter theo date
          if (fromDate || toDate) {
            const recordDate = record.Ng√†y || record.NgayGiaoDich || record.NgayChiPhi;
            if (recordDate) {
              const date = new Date(recordDate);
              if (fromDate && date < new Date(fromDate)) include = false;
              if (toDate && date > new Date(toDate)) include = false;
            }
          }
          
          // Filter theo user
          if (userId) {
            const recordUserId = record.ID_NhanVien || record.NguoiLap;
            if (recordUserId !== userId) include = false;
          }
          
          return include;
        });
      });
    }
    
    return ContentService
      .createTextOutput(JSON.stringify(data))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        error: 'L·ªói khi l·ªçc d·ªØ li·ªáu: ' + error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// === TEST FUNCTIONS ===

/**
 * Test function ƒë·ªÉ ki·ªÉm tra d·ªØ li·ªáu
 */
function testDataRetrieval() {
  console.log('=== KI·ªÇM TRA D·ªÆ LI·ªÜU ===');
  
  try {
    // Test k·∫øt n·ªëi spreadsheet
    const ss = getSpreadsheet();
    console.log('Spreadsheet ID:', ss.getId());
    console.log('Spreadsheet Name:', ss.getName());
    
    // Test t·ª´ng sheet quan tr·ªçng
    const testSheets = [
      CONFIG.SHEETS.USER,
      CONFIG.SHEETS.CHAM_CONG,
      CONFIG.SHEETS.GIAO_DICH_LUONG,
      CONFIG.SHEETS.CHIPHI
    ];
    
    testSheets.forEach(sheetName => {
      try {
        if (sheetExists(sheetName)) {
          const data = getDataFromSheet(sheetName, 3); // Ch·ªâ l·∫•y 3 d√≤ng ƒë·∫ßu
          console.log(`‚úÖ ${sheetName}: ${data.length} b·∫£n ghi`);
          if (data.length > 0) {
            console.log(`   C·ªôt: ${Object.keys(data[0]).slice(0, 5).join(', ')}...`);
          }
        } else {
          console.log(`‚ùå ${sheetName}: Sheet kh√¥ng t·ªìn t·∫°i`);
        }
      } catch (e) {
        console.log(`‚ö†Ô∏è ${sheetName}: L·ªói - ${e.message}`);
      }
    });
    
    // Test API endpoints
    console.log('\n=== TEST API ENDPOINTS ===');
    
    // Test doGet without parameters
    console.log('Testing doGet()...');
    const testResult = doGet(null);
    console.log('doGet() test: OK');
    
    // Test doGet with empty object
    const testResult2 = doGet({});
    console.log('doGet({}) test: OK');
    
    // Test doGet with parameter
    const testResult3 = doGet({ parameter: { action: 'getStats' } });
    console.log('doGet with parameters test: OK');
    
    return 'Test completed successfully';
    
  } catch (error) {
    console.error('L·ªói trong test:', error);
    console.error('Error stack:', error.stack);
    return 'Test failed: ' + error.message;
  }
}

/**
 * Test ƒë∆°n gi·∫£n ch·ªâ l·∫•y d·ªØ li·ªáu User
 */
function testUserDataOnly() {
  try {
    console.log('Testing User data...');
    const userData = getDataFromSheet(CONFIG.SHEETS.USER, 5);
    console.log('User data count:', userData.length);
    
    if (userData.length > 0) {
      console.log('First user:', userData[0]);
      console.log('User columns:', Object.keys(userData[0]));
    }
    
    return userData;
  } catch (error) {
    console.error('Error in testUserDataOnly:', error);
    return null;
  }
}

/**
 * Test API endpoint tr·ª±c ti·∫øp
 */
function testDirectAPI() {
  try {
    console.log('=== TEST DIRECT API ===');
    
    // Test getAllData
    const result1 = getAllData();
    console.log('getAllData: Success');
    
    // Test getUserDataOnly
    const result2 = getUserDataOnly();
    console.log('getUserDataOnly: Success');
    
    // Test getStatistics
    const result3 = getStatistics();
    console.log('getStatistics: Success');
    
    return 'All API tests passed';
    
  } catch (error) {
    console.error('API test failed:', error);
    return 'API test failed: ' + error.message;
  }
}

/**
 * T·∫°o sample HTML ƒë·ªÉ test
 */
function createSampleHTML() {
  const html = `
<!DOCTYPE html>
<html>
<head>
    <title>Test Dashboard API</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Test Dashboard API</h1>
    <button onclick="testAPI()">Test API</button>
    <div id="result"></div>
    
    <script>
    const API_URL = 'YOUR_WEB_APP_URL_HERE';
    
    function testAPI() {
        $('#result').html('ƒêang t·∫£i...');
        
        fetch(API_URL + '?action=getStats')
        .then(response => response.json())
        .then(data => {
            $('#result').html('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
        })
        .catch(error => {
            $('#result').html('L·ªói: ' + error.message);
        });
    }
    </script>
</body>
</html>
  `;
  
  return html;
}

Tr√™n ƒê√¢y l√† ƒëo·∫°n code.gs c·ªßa t√¥i.
v√† API URL: AKfycbwmW-plingk-e11esKWeWkpSwmUpkGWsNrgviTm5qTxawcj7nPNk4rCLS--S09LnHzgvg

T√¥i y√™u c·∫ßu b·∫°n gi√∫p t√¥i.
- Ho√†n ch·ªânh l·∫°i c√°c ƒëo·∫°n code gs v√† HTM ƒë·ªÉ hi·ªÉn th·ªã HTML. ƒê·ªÅ ngh·ªã m·∫´u HTML hi·ªán ƒë·∫°i v·ªõi nhi·ªÅu ch·ª©c nƒÉng.
- T√¥i mu·ªën host ƒëo·∫°n html n√†y tr√™n Google script (V·∫≠y c·∫ßn s·ª≠a code.gs)