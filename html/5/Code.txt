/**
 * Google Apps Script API cho Dashboard Quản Lý Tổng Hợp
 * Author: Assistant
 * Date: 2025
 * Version: 2.2 (Cập nhật biểu đồ nhân sự & Sửa lỗi API Mua sắm)
 */

// === MAIN API ENDPOINT ===
function doGet(e) {
  try {
    const parameter = (e && e.parameter) ? e.parameter : {};
    const action = parameter.action;

    if (!action) {
      return HtmlService.createTemplateFromFile('index')
        .evaluate()
        .setTitle('Dashboard Quản Lý Tổng Hợp')
        .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    }

    console.log('API call received with action:', action);
    switch (action) {
      case 'getBusinessData': return getBusinessData(parameter.business);
      case 'getStats': return getStatistics();
      case 'getInventoryData': return getInventoryData();
      default:
        return ContentService
          .createTextOutput(JSON.stringify({ error: 'Action không hợp lệ: ' + action }))
          .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Lỗi trong doGet:', error, error.stack);
    return ContentService
      .createTextOutput(JSON.stringify({
        error: 'Có lỗi xảy ra: ' + error.message,
        details: error.stack,
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// === CONFIGURATION ===
const CONFIG = {
  SHEETS: {
    USER: 'User',
    CHIPHI: 'Chiphi',
    CHIPHI_CHITIET: 'Chiphichitiet',
    DS_KHO: 'DS_kho',
    CHAM_CONG: 'Chamcong',
    GIAO_DICH_LUONG: 'GiaoDichLuong',
    PHIEU_NHAP_XUAT: 'PhieuNhapXuat',
    PNX_CHI_TIET: 'PNXChiTiet',
    VAT_LIEU: 'VatLieu'
  }
};

// === UTILITY FUNCTIONS ===
function getSpreadsheet() { return SpreadsheetApp.getActiveSpreadsheet(); }
function sheetExists(sheetName) { return getSpreadsheet().getSheetByName(sheetName) !== null; }

function rangeToObjects(range) {
  if (!range || range.length < 2) return [];
  const headers = range[0].map(h => h.toString().trim());
  return range.slice(1).map((row, index) => {
    const obj = {};
    headers.forEach((header, colIndex) => {
      let value = row[colIndex];
      if (value instanceof Date) {
        value = Utilities.formatDate(value, Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');
      }
      obj[header] = value;
    });
    return obj;
  });
}

// === CACHING & DATA RETRIEVAL (IMPROVED) ===
function getCachedDataFromSheet(sheetName) {
  const cache = CacheService.getScriptCache();
  const cacheKey = `data_${sheetName}`;
  
  const cachedData = cache.get(cacheKey);
  if (cachedData !== null) {
    console.log(`Lấy dữ liệu từ CACHE cho sheet: ${sheetName}`);
    return JSON.parse(cachedData);
  }

  console.log(`Lấy dữ liệu từ SHEET cho sheet: ${sheetName}`);
  try {
    if (!sheetExists(sheetName)) return [];
    const sheet = getSpreadsheet().getSheetByName(sheetName);
    const range = sheet.getDataRange().getValues();
    const objects = rangeToObjects(range);
    
    cache.put(cacheKey, JSON.stringify(objects), 600);  
    
    return objects;
  } catch (error) {
    console.error(`Lỗi khi lấy dữ liệu từ sheet "${sheetName}":`, error);
    return [];
  }
}

function getDataFromSheet(sheetName) {
  return getCachedDataFromSheet(sheetName);
}

function filterActiveRecords(data) {
  if (!data || !Array.isArray(data)) return [];
  return data.filter(record => record && (record.Delete !== true && record.Delete !== 'true' && record.Delete !== 'TRUE'));
}

// === DATA RETRIEVAL FUNCTIONS ===

function getBusinessData(businessType) {
  let businessData = {};
  switch (businessType) {
    case 'hr':
      businessData = {
        users: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.USER)),
        chamCong: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG)),
        giaoDichLuong: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.GIAO_DICH_LUONG)),
        dsKho: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DS_KHO))
      };
      break;
    // --- SỬA LỖI: Bổ sung case 'shopping' để lấy dữ liệu mua sắm ---
    case 'shopping':
        businessData = {
            chiphi: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI)),
            chiphiChitiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI_CHITIET))
        };
        break;
  }
  return ContentService.createTextOutput(JSON.stringify(businessData)).setMimeType(ContentService.MimeType.JSON);
}

function getInventoryData() {
  try {
    const inventoryData = {
      phieuNhapXuat: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PHIEU_NHAP_XUAT)),
      pnxChiTiet: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.PNX_CHI_TIET)),
      vatLieu: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.VAT_LIEU)),
      dsKho: filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DS_KHO))
    };
    return ContentService
      .createTextOutput(JSON.stringify(inventoryData))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    console.error('Lỗi khi lấy dữ liệu kho:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ error: 'Lỗi khi lấy dữ liệu kho: ' + error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function getStatistics() {
  try {
    const now = new Date();
    const todayStr = Utilities.formatDate(now, Session.getScriptTimeZone(), 'yyyy-MM-dd');

    const users = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.USER));
    const chamCong = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHAM_CONG));
    const chiphiChitiet = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI_CHITIET));
    const dsKho = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.DS_KHO));
    const chiphi = filterActiveRecords(getDataFromSheet(CONFIG.SHEETS.CHIPHI));

    const activeEmployeeList = users.filter(u => u['Trạng thái'] === 'Đang làm việc');
    const totalActiveEmployees = activeEmployeeList.length;
    const activeEmployeeIDs = new Set(activeEmployeeList.map(u => u.ID));
    
    // Tính số nhân sự chưa chấm công trong tháng hiện tại
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    const chamCongThisMonth = chamCong.filter(rec => {
        if (!rec.Ngày) return false;
        const recDate = new Date(rec.Ngày);
        return recDate.getMonth() + 1 === currentMonth && 
               recDate.getFullYear() === currentYear &&
               activeEmployeeIDs.has(rec.ID_NhanVien);
    });
    const workedThisMonthCount = new Set(chamCongThisMonth.map(rec => rec.ID_NhanVien)).size;
    const notWorkedThisMonthCount = totalActiveEmployees - workedThisMonthCount;
    
    const attendedToday = new Set(chamCong.filter(rec => rec.Ngày && rec.Ngày.toString().startsWith(todayStr) && activeEmployeeIDs.has(rec.ID_NhanVien)).map(rec => rec.ID_NhanVien)).size;
    
    const khoMap = dsKho.reduce((map, kho) => {
        map[kho['ID kho']] = kho['Tên kho'];
        return map;
    }, {});
    
    const totalExpenses = chiphi.reduce((sum, record) => sum + (parseFloat(record.TongSoTien) || 0), 0);
    
    const expensesByWarehouse = chiphiChitiet.reduce((acc, item) => {
      const khoName = khoMap[item.Ten_Kho] || item.Ten_Kho || 'Không xác định';
      acc[khoName] = (acc[khoName] || 0) + (parseFloat(item.SoTien) || 0);
      return acc;
    }, {});

    // --- CẬP NHẬT: Tính toán nhân sự theo kho cho 3 tháng gần nhất ---
    const personnelByWarehouseMonthly = {};
    for (let i = 0; i < 3; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const targetMonth = targetDate.getMonth() + 1;
        const targetYear = targetDate.getFullYear();
        const monthKey = `${targetYear}-${String(targetMonth).padStart(2, '0')}`; // e.g., "2025-07"

        const chamCongInMonth = chamCong.filter(rec => {
            if (!rec.Ngày) return false;
            const recDate = new Date(rec.Ngày);
            return recDate.getMonth() + 1 === targetMonth && 
                   recDate.getFullYear() === targetYear &&
                   activeEmployeeIDs.has(rec.ID_NhanVien);
        });

        const personnelByWarehouseInMonth = chamCongInMonth.reduce((acc, rec) => {
            const khoName = khoMap[rec.Kholamviec] || rec.Kholamviec || 'Không xác định';
            if (!acc[khoName]) acc[khoName] = new Set();
            acc[khoName].add(rec.ID_NhanVien);
            return acc;
        }, {});
    
        const personnelCount = {};
        for (const kho in personnelByWarehouseInMonth) {
            personnelCount[kho] = personnelByWarehouseInMonth[kho].size;
        }
        personnelByWarehouseMonthly[monthKey] = personnelCount;
    }

    const stats = {
      timestamp: new Date().toISOString(),
      hr: {
        totalEmployees: users.length,
        activeEmployees: totalActiveEmployees,
        inactiveThisMonth: notWorkedThisMonthCount,
        attendedToday: attendedToday,
        notAttendedToday: totalActiveEmployees - attendedToday,
      },
      costs: {
        totalExpenses: totalExpenses,
        expensesByWarehouse: expensesByWarehouse
      },
      warehouse: {
        // --- CẬP NHẬT: Trả về dữ liệu mới ---
        personnelByWarehouseMonthly: personnelByWarehouseMonthly
      }
    };

    return ContentService.createTextOutput(JSON.stringify(stats)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
     console.error('Lỗi khi tính toán thống kê:', error, error.stack);
    return ContentService.createTextOutput(JSON.stringify({ error: 'Lỗi khi tính toán thống kê: ' + error.message, details: error.stack })).setMimeType(ContentService.MimeType.JSON);
  }
}